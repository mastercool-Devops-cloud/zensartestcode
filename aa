import static org.mockito.Mockito.*;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.text.ParseException;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;
import org.mockito.MockedStatic;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.test.util.ReflectionTestUtils;

import static org.junit.jupiter.api.Assertions.*;

import org.junit.jupiter.api.extension.ExtendWith;

@ExtendWith(MockitoExtension.class)
class FxPasswordSubscriberTest {

    @BeforeEach
    void setUp() {
        // Prepare any necessary setup before each test
    }

    @Test
    void testGetDbCredentials_Success() throws Exception {
        String mockUrl = "http://mockurl";
        String mockResponse = "{\"UserName\":\"testUser\",\"Content\":\"testPass\"}";

        // Mock static methods
        try (MockedStatic<LogManager> logManagerMock = mockStatic(LogManager.class);
             MockedStatic<Files> filesMock = mockStatic(Files.class)) {

            Logger mockLogger = mock(Logger.class);
            logManagerMock.when(() -> LogManager.getLogger(FxPasswordSubscriber.class)).thenReturn(mockLogger);

            // Mocking URL connection and response
            HttpURLConnection mockConnection = mock(HttpURLConnection.class);
            when(mockConnection.getResponseCode()).thenReturn(HttpURLConnection.HTTP_OK);
            when(mockConnection.getInputStream()).thenReturn(new ByteArrayInputStream(mockResponse.getBytes()));

            try (MockedStatic<URL> urlMock = mockStatic(URL.class)) {
                urlMock.when(() -> new URL(mockUrl)).thenReturn(new URL(mockUrl));

                // Mock the connection object
                when(urlMock.openConnection()).thenReturn(mockConnection);

                // Call the method
                DbCredentials credentials = FxPasswordSubscriber.getDbCredentials(mockUrl);

                // Verify credentials
                assertNotNull(credentials);
                assertEquals("testUser", credentials.getUsername());
                assertEquals("testPass", credentials.getPassword());

                // Verify logger interaction
                ArgumentCaptor<String> captor = ArgumentCaptor.forClass(String.class);
                verify(mockLogger).info(captor.capture());
                assertTrue(captor.getValue().contains("JavaKeyStore Path For Vault API"));
            }
        }
    }

    @Test
    void testGetDbCredentials_Failure() throws Exception {
        String mockUrl = "http://mockurl";

        // Mock static methods
        try (MockedStatic<LogManager> logManagerMock = mockStatic(LogManager.class);
             MockedStatic<Files> filesMock = mockStatic(Files.class)) {

            Logger mockLogger = mock(Logger.class);
            logManagerMock.when(() -> LogManager.getLogger(FxPasswordSubscriber.class)).thenReturn(mockLogger);

            // Mocking URL connection failure
            HttpURLConnection mockConnection = mock(HttpURLConnection.class);
            when(mockConnection.getResponseCode()).thenReturn(HttpURLConnection.HTTP_INTERNAL_ERROR);

            try (MockedStatic<URL> urlMock = mockStatic(URL.class)) {
                urlMock.when(() -> new URL(mockUrl)).thenReturn(new URL(mockUrl));
                when(urlMock.openConnection()).thenReturn(mockConnection);

                // Call the method
                DbCredentials credentials = FxPasswordSubscriber.getDbCredentials(mockUrl);

                // Verify credentials
                assertNull(credentials);

                // Verify logger interaction
                ArgumentCaptor<String> captor = ArgumentCaptor.forClass(String.class);
                verify(mockLogger).error(captor.capture());
                assertTrue(captor.getValue().contains("Failed to fetch credentials"));
            }
        }
    }
}
